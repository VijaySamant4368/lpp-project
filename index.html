<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Optimal Route Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:system-ui,Arial,sans-serif; background:#0b0c10; color:#e6e6e6; display:grid; grid-template-columns:380px 1fr; height:100vh; }
    #sidebar { padding:20px; border-right:1px solid #222; background:#111218; overflow-y:auto; }
    #map { width:100%; height:100%; }
    h2 { margin:0 0 20px; font-size:22px; }
    .section { background:#161822; padding:18px; border-radius:12px; margin-bottom:16px; }
    label { font-size:13px; opacity:0.9; display:block; margin-bottom:6px; }
    input[type="text"] { width:100%; padding:12px; border-radius:10px; border:1px solid #2a2e3b; background:#0f1118; color:#e6e6e6; outline:none; font-size:14px; margin-bottom:12px; }
    button { padding:12px 20px; border-radius:10px; border:none; cursor:pointer; font-weight:600; font-size:14px; margin:6px 0; width:100%; }
    button.primary { background:#2f5cff; color:white; }
    button.secondary { background:#1b1f2b; border:1px solid #2a2e3b; color:#e6e6e6; }
    .checkboxes label { display:flex; align-items:center; gap:10px; font-size:14px; cursor:pointer; margin:8px 0; user-select:none; }
    .checkboxes input[type="checkbox"] { width:18px; height:18px; accent-color:#2f5cff; }
    .status { margin-top:12px; font-size:13px; opacity:0.9; }
    .hint { font-size:12px; opacity:0.7; margin-top:8px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Optimal Route Finder</h2>
    <div class="section">
      <label>Start place</label>
      <input id="startInput" list="startSuggestions" type="text" placeholder="e.g. MG Road" />
      <datalist id="startSuggestions"></datalist>

      <label>End place</label>
      <input id="endInput" list="endSuggestions" type="text" placeholder="e.g. Koramangala" />
      <datalist id="endSuggestions"></datalist>

      <div class="checkboxes">
        <label><input type="checkbox" id="chkPrimary" checked> Primary roads</label>
        <label><input type="checkbox" id="chkSecondary" checked> Secondary roads</label>
        <label><input type="checkbox" id="chkTertiary" checked> Tertiary / Village roads</label>
      </div>

      <button id="viewFullBtn" class="secondary">View Full Map</button>
      <button id="calcBtn" class="primary">Calculate Route</button>

      <div id="status" class="status"></div>
      <div class="hint">Check-Uncheck road types for different routes</div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([12.9716, 77.5946], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    let routeLayer = null;
    let networkLayers = [];
    let networkVisible = false;
    let networkLoaded = false;

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    function clearRoute() {
      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
    }

    function clearNetwork() {
      networkLayers.forEach(l => map.removeLayer(l));
      networkLayers = [];
      networkVisible = false;
      networkLoaded = false;
      document.getElementById("viewFullBtn").textContent = "View Full Map";
    }

    // === AUTOCOMPLETE SUGGESTIONS ===
    async function updateSuggestions(inputId, datalistId) {
      const input = document.getElementById(inputId);
      const dl = document.getElementById(datalistId);
      const q = input.value.trim();
      if (q.length < 2) { dl.innerHTML = ""; return; }

      try {
        const res = await fetch(`http://127.0.0.1:8000/suggest?q=${encodeURIComponent(q)}&limit=10`);
        const data = await res.json();
        dl.innerHTML = "";
        (data.suggestions || []).forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          dl.appendChild(opt);
        });
      } catch (err) { console.error(err); }
    }

    document.getElementById("startInput").addEventListener("input", () => updateSuggestions("startInput", "startSuggestions"));
    document.getElementById("endInput").addEventListener("input", () => updateSuggestions("endInput", "endSuggestions"));

    // === VIEW FULL MAP ===
    document.getElementById("viewFullBtn").addEventListener("click", async () => {
      const btn = document.getElementById("viewFullBtn");
      if (networkVisible) { clearNetwork(); setStatus("Full map hidden."); return; }

      setStatus("Loading full road network...");
      clearRoute();

      if (!networkLoaded) {
        try {
          const res = await fetch("http://127.0.0.1:8000/get-full-graph");
          const data = await res.json();
          const colorMap = { primary: "#1E90FF", secondary: "#32CD32", tertiary: "#964B00" };
          const widthMap = { primary: 7, secondary: 5, tertiary: 3 };

          data.edges.forEach(e => {
            const poly = L.polyline(e.coords, {
              color: colorMap[e.type] || "#888",
              weight: widthMap[e.type] || 2,
              opacity: 0.6
            }).addTo(map);
            networkLayers.push(poly);
          });
          networkLoaded = true;
        } catch (err) {
          setStatus("Failed to load full map");
          console.error(err);
          return;
        }
      } else {
        networkLayers.forEach(l => l.addTo(map));
      }

      networkVisible = true;
      btn.textContent = "Hide Full Map";
      map.fitBounds(L.featureGroup(networkLayers).getBounds().pad(0.05));
      setStatus("Full road network displayed");
    });

    // === CALCULATE ROUTE ===
    document.getElementById("calcBtn").addEventListener("click", async () => {
      const start = document.getElementById("startInput").value.trim();
      const end = document.getElementById("endInput").value.trim();
      if (!start || !end) return setStatus("Please enter both places");

      const payload = {
        start, end,
        primary: document.getElementById("chkPrimary").checked,
        secondary: document.getElementById("chkSecondary").checked,
        tertiary: document.getElementById("chkTertiary").checked
      };

      setStatus("Finding your route...");
      clearRoute();

      try {
        const res = await fetch("http://127.0.0.1:8000/get-route", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();

        if (!data.polylines?.length) throw new Error("No route found");

        routeLayer = L.polyline(data.polylines.flat(), {
          color: "#ff3399",
          weight: 6,
          opacity: 1,
          dashArray: "15, 15",
          dashOffset: "0"
        }).addTo(map);

        // Animation â€” the line "runs" forward
        function animateDash() {
          const offset = (Number(routeLayer.options.dashOffset || 0) - 1) % 30;
          routeLayer.setStyle({ dashOffset: offset.toString() });
          requestAnimationFrame(animateDash);
        }
        animateDash();

        map.fitBounds(routeLayer.getBounds().pad(0.1));
        setStatus(`Route ready: ${(data.distance_m / 1000).toFixed(1)} km`);
      } catch (err) {
        setStatus("Error: " + err.message);
        console.error(err);
      }
    });
  </script>
</body>
</html>